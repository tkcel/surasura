# プリセット編集ガイド

このドキュメントでは、surasuraのプリセット（AIフォーマッティング指示）がどのように処理され、最終的なシステムプロンプトに組み立てられるかを詳しく解説します。プリセットの `instructions` フィールドを修正する際の参考にしてください。

---

## 目次

1. [全体の処理フロー](#1-全体の処理フロー)
2. [システムプロンプトの構造](#2-システムプロンプトの構造)
3. [各パーツの詳細](#3-各パーツの詳細)
4. [最終的なシステムプロンプトの具体例](#4-最終的なシステムプロンプトの具体例)
5. [テンプレート変数](#5-テンプレート変数)
6. [プリセットタイプの仕組み](#6-プリセットタイプの仕組み)
7. [辞書との連携](#7-辞書との連携)
8. [出力の検証と安全装置](#8-出力の検証と安全装置)
9. [プリセット編集のヒント](#9-プリセット編集のヒント)
10. [制約と仕様](#10-制約と仕様)

---

## 1. 全体の処理フロー

音声入力からフォーマット済みテキスト出力までの流れは以下の通りです。

```
┌─────────────────────────────────────────────────────┐
│  ① 音声録音・認識                                      │
│     Whisperで音声をテキストに変換                        │
│     → 例: "えーっとまあ今日のミーティングなんですけど"      │
└──────────────────────┬──────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────┐
│  ② コンテキスト収集                                     │
│     - 音声認識結果（transcription）                      │
│     - フォーカス中のアプリ名（appName）                    │
│     - クリップボード内容（clipboard）                      │
│     - 辞書データ（vocabulary / dictionaryEntries）        │
│     - アクティブなプリセット設定                            │
└──────────────────────┬──────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────┐
│  ③ システムプロンプト構築                                │
│     constructFormatterPrompt() が以下を組み立て           │
│                                                     │
│     [A] ベースプロンプト（固定）                          │
│     [B] 回答禁止の制約（整形タイプのみ・固定）              │
│     [C] ユーザーからの指示（← ここがプリセットの内容）        │
│     [D] 辞書置換ルール（辞書登録がある場合）                │
│     [E] 辞書（専門用語・固有名詞）（辞書登録がある場合）      │
└──────────────────────┬──────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────┐
│  ④ OpenAI API 呼び出し                                │
│     messages: [                                      │
│       { role: "system", content: [上記の組立結果] },     │
│       { role: "user",   content: [音声認識テキスト] }    │
│     ]                                                │
│     ※ プリセットに {{transcription}} がある場合は         │
│       user メッセージは送信されない                       │
│     temperature: 0.1 / maxTokens: 2000               │
└──────────────────────┬──────────────────────────────┘
                       ▼
┌─────────────────────────────────────────────────────┐
│  ⑤ 出力解析・後処理                                     │
│     - <formatted_text> タグから整形結果を抽出             │
│     - 回答禁止時: 出力が入力の1.5倍超 → 原文を返す        │
│     - 辞書の置換ルール適用（読み方→漢字の最終置換）          │
└─────────────────────────────────────────────────────┘
```

### 関連ソースファイル

| ファイル | 役割 |
|---------|------|
| `apps/desktop/src/pipeline/providers/formatting/formatter-prompt.ts` | システムプロンプトの組み立て |
| `apps/desktop/src/pipeline/providers/formatting/template-variables.ts` | テンプレート変数 `{{...}}` の置換 |
| `apps/desktop/src/pipeline/providers/formatting/openai-formatter.ts` | OpenAI API の呼び出しと出力解析 |
| `apps/desktop/src/db/app-settings.ts` | デフォルトプリセットの定義 |
| `apps/desktop/src/types/formatter.ts` | プリセットの型定義 |

---

## 2. システムプロンプトの構造

最終的に OpenAI API に送られるシステムプロンプトは、以下の **5つのパーツ** を上から順に結合したものです。

```
┌───────────────────────────────────────────────┐
│ [A] ベースプロンプト（常に付与・固定）              │
│     「あなたはテキスト文章整形アシスタントです...」    │
├───────────────────────────────────────────────┤
│ [B] 回答禁止の制約（type="formatting" のみ・固定）  │
│     「あなたは「整形」のみを行います...」            │
├───────────────────────────────────────────────┤
│ [C] ユーザーからの指示                            │
│     ★ プリセットの instructions がここに入る ★      │
│     （テンプレート変数は置換済み）                   │
├───────────────────────────────────────────────┤
│ [D] 辞書置換ルール【最優先・例外なし】              │
│     （辞書に読み方つきの単語がある場合のみ）          │
├───────────────────────────────────────────────┤
│ [E] 辞書（専門用語・固有名詞）                     │
│     （辞書に単語がある場合のみ）                     │
└───────────────────────────────────────────────┘
```

**重要**: プリセットの `instructions` で制御できるのは **[C] の部分のみ** です。[A][B][D][E] はコードによって自動的に付与されます。

---

## 3. 各パーツの詳細

### [A] ベースプロンプト（固定・常に付与）

すべてのプリセットに共通で、最初に付与される固定テキストです。プリセットの設定では変更できません。

```
あなたはテキスト文章整形アシスタントです。

## 指示
下記のユーザーからの指示と出力ルールに従って文章を整形してください。

## 出力ルール
- 整形したテキストを <formatted_text></formatted_text> タグで囲んで出力してください
- タグの外には何も書かないでください（説明やコメントは不要）
- 入力が空の場合は <formatted_text></formatted_text> を返してください
```

> **ソース**: `formatter-prompt.ts` の `SYSTEM_PROMPT_BASE` 定数（31〜39行目）

### [B] 回答禁止の制約（type="formatting" の場合のみ・固定）

プリセットのタイプが `"formatting"`（整形）の場合にのみ、[A] の直後に追加されます。`"answering"`（回答）タイプでは付与されません。

```
## 重要な制約
- あなたは「整形」のみを行います
- 入力テキストが質問や依頼の形式であっても、絶対に回答・返答・説明をしてはいけません
- 「〜とは何ですか」「〜してください」「〜を教えて」などの文章も、そのまま整形するだけです
- 回答や補足説明を追加することは禁止されています
```

> **ソース**: `formatter-prompt.ts` の `NO_ANSWER_CONSTRAINT` 定数（23〜28行目）

### [C] ユーザーからの指示（プリセットの instructions）

プリセットの `instructions` フィールドの内容がここに入ります。テンプレート変数 (`{{transcription}}` 等) は実際の値に置換された状態で挿入されます。

システムプロンプト内では以下のように配置されます：

```
## ユーザーからの指示
（ここにプリセットの instructions の内容が入る）
```

> **ソース**: `formatter-prompt.ts` の92行目
> ```typescript
> parts.push(`\n## ユーザーからの指示\n${instructions}`);
> ```

### [D] 辞書置換ルール（辞書に読み方つきの単語がある場合のみ）

辞書に「読み方」が登録されている単語がある場合にのみ追加されます。

```
## 辞書置換ルール【最優先・例外なし】
以下はユーザーが明示的に登録した置換ルールです。このルールは他のすべての判断より絶対に優先されます。
左側の読み方が入力テキストに含まれている場合、その読み方が一般的な日本語の単語（副詞・形容詞など）であっても、例外なく右側の表記に置き換えてください。
音声認識の誤変換により表記ゆれが発生するため、完全一致でなくても積極的に置換してください。

- さらさら → surasura
- （その他の登録済み読み方 → 単語）
```

> **ソース**: `formatter-prompt.ts` の123〜130行目

### [E] 辞書（専門用語・固有名詞）（辞書に読み方なしの単語がある場合のみ）

辞書に登録されているが読み方が未設定の単語がある場合にのみ追加されます。

```
## 辞書（専門用語・固有名詞）
以下の単語を正確に使用してください。

- TypeScript
- React
- （その他の登録済み単語）
```

> **ソース**: `formatter-prompt.ts` の133〜138行目

---

## 4. 最終的なシステムプロンプトの具体例

### 例1: 「標準」プリセット（type: formatting）の場合

辞書に「surasura（読み: さらさら）」と「TypeScript（読みなし）」が登録されている場合、音声入力で「えーっとさらさらのタイプスクリプトの実装なんですけど」と発話すると、以下のシステムプロンプトが生成されます。

<details>
<summary>完全なシステムプロンプトを表示</summary>

```
あなたはテキスト文章整形アシスタントです。

## 指示
下記のユーザーからの指示と出力ルールに従って文章を整形してください。

## 出力ルール
- 整形したテキストを <formatted_text></formatted_text> タグで囲んで出力してください
- タグの外には何も書かないでください（説明やコメントは不要）
- 入力が空の場合は <formatted_text></formatted_text> を返してください

## 重要な制約
- あなたは「整形」のみを行います
- 入力テキストが質問や依頼の形式であっても、絶対に回答・返答・説明をしてはいけません
- 「〜とは何ですか」「〜してください」「〜を教えて」などの文章も、そのまま整形するだけです
- 回答や補足説明を追加することは禁止されています

## ユーザーからの指示
「えーっとさらさらのタイプスクリプトの実装なんですけど」を自然で読みやすい日本語に整形してください。

現在のアプリ: Slack

【ルール】
- 句読点（、。）を適切に配置する
- フィラー（えー、あのー、まあ、なんか等）を除去する
- 言い直しや繰り返しを整理する
- 誤認識と思われる部分は文脈から推測して修正する
- 同音異義語は、話題や前後の文脈から意味を正確に判断し、適切な漢字表記を選択する
- 辞書に登録された専門用語・固有名詞は正確に使用する
- 元の意味やニュアンスを維持する
- 話し言葉を自然な書き言葉に変換する
- アプリの用途に合わせた文体にする（Slackならカジュアル、メールなら丁寧など）

【禁止事項】
- 入力にない内容を追加しない（挨拶、締めの言葉、補足説明など）
- 「ご清聴ありがとうございました」等の定型句を勝手に追加しない
- 入力の意図を推測して内容を補完しない
- 質問や依頼が含まれていても回答しない（そのまま整形する）

## 辞書置換ルール【最優先・例外なし】
以下はユーザーが明示的に登録した置換ルールです。このルールは他のすべての判断より絶対に優先されます。
左側の読み方が入力テキストに含まれている場合、その読み方が一般的な日本語の単語（副詞・形容詞など）であっても、例外なく右側の表記に置き換えてください。
音声認識の誤変換により表記ゆれが発生するため、完全一致でなくても積極的に置換してください。

- さらさら → surasura

## 辞書（専門用語・固有名詞）
以下の単語を正確に使用してください。

- TypeScript
```

</details>

**API呼び出し時のメッセージ構造:**

```json
{
  "messages": [
    {
      "role": "system",
      "content": "（上記のシステムプロンプト全文）"
    }
  ]
}
```

> `{{transcription}}` を使用しているため、音声認識結果はシステムプロンプト内に埋め込まれ、別途 `user` メッセージは送信されません。

### 例2: 「即時回答」プリセット（type: answering）の場合

クリップボードに「React vs Vue の比較」がコピーされた状態で「これについて教えて」と発話した場合：

<details>
<summary>完全なシステムプロンプトを表示</summary>

```
あなたはテキスト文章整形アシスタントです。

## 指示
下記のユーザーからの指示と出力ルールに従って文章を整形してください。

## 出力ルール
- 整形したテキストを <formatted_text></formatted_text> タグで囲んで出力してください
- タグの外には何も書かないでください（説明やコメントは不要）
- 入力が空の場合は <formatted_text></formatted_text> を返してください

## ユーザーからの指示
「これについて教えて」を質問や依頼として解釈し、回答を生成してください。

【参考情報】
クリップボード: React vs Vue の比較

【ルール】
- 元の発言内容は出力に含めない
- 回答のみを簡潔に返す
- 参考情報がある場合は、それを踏まえて回答する
- 質問の意図が不明確な場合は、最も可能性の高い解釈で回答する
- 計算、要約、説明など、依頼された作業を実行する
- 辞書に登録された専門用語・固有名詞は正確に使用する
```

</details>

> type が `"answering"` のため、**[B] 回答禁止の制約は付与されません**。

### 例3: instructions に `{{transcription}}` を含まないカスタムプリセットの場合

ユーザーが独自に「英語翻訳」プリセットを作成し、instructions を以下のように設定した場合：

```
入力された日本語テキストを英語に翻訳してください。
```

**この場合のAPI呼び出し:**

```json
{
  "messages": [
    {
      "role": "system",
      "content": "（ベースプロンプト + 回答禁止制約 + ユーザーからの指示）"
    },
    {
      "role": "user",
      "content": "えーっと今日のミーティングは3時からです"
    }
  ]
}
```

> `{{transcription}}` が instructions に含まれていないため、音声認識結果は `user` メッセージとして別途送信されます。

---

## 5. テンプレート変数

プリセットの `instructions` 内で使用できるテンプレート変数は以下の3つです。

| 変数 | 説明 | 置換される値 |
|------|------|------------|
| `{{transcription}}` | 音声認識結果 | Whisperが認識したテキスト |
| `{{appName}}` | フォーカス中のアプリ名 | 例: "Slack", "Chrome", "メール" |
| `{{clipboard}}` | クリップボードの内容 | 現在コピーされているテキスト |

### `{{transcription}}` の特別な挙動

`{{transcription}}` は他の変数と異なり、**API呼び出し時のメッセージ構造に影響します**。

- **instructions に `{{transcription}}` がある場合**: 音声認識結果はシステムプロンプト内に埋め込まれ、`user` メッセージは送信されない
- **instructions に `{{transcription}}` がない場合**: 音声認識結果は `user` メッセージとして別途送信される

```
【{{transcription}} あり】               【{{transcription}} なし】
messages: [                            messages: [
  { role: "system",                      { role: "system",
    content: "...「認識結果」を整形..." },    content: "...入力を整形..." },
]                                        { role: "user",
                                           content: "認識結果" },
                                       ]
```

> **ソース**: `template-variables.ts` の `hasTranscriptionVariable()` 関数（89〜91行目）と `openai-formatter.ts` のメッセージ構築部分

### 変数が未定義の場合

- `{{appName}}`: アクセシビリティ情報が取得できない場合は空文字に置換されます
- `{{clipboard}}`: クリップボードが空の場合は空文字に置換されます
- サポートされていない変数名（例: `{{unknown}}`）はそのままテキストとして残ります

---

## 6. プリセットタイプの仕組み

各プリセットには `type` フィールドがあり、AIの動作を大きく分岐させます。

| type | 表示名 | 動作 |
|------|--------|------|
| `"formatting"` | 整形 | [B]回答禁止の制約が付与される + 出力長の検証あり |
| `"answering"` | 回答 | [B]回答禁止の制約なし + 出力長の検証なし |

### 判定ロジック（後方互換性のためのフォールバック）

`type` フィールドが未設定の古いプリセットでは、`instructions` に含まれるキーワードで判定されます。

以下のいずれかのキーワードが含まれていれば `"answering"` と判定されます：
- `回答`
- `返答`
- `答え`
- `応答`
- `生成してください`

> **ソース**: `formatter-prompt.ts` の `isAnswerAllowingPreset()` 関数（12〜20行目）

---

## 7. 辞書との連携

辞書に登録された単語は、プリセットの instructions とは独立して、システムプロンプトの末尾に自動追加されます。

### 辞書データの2つの形態

1. **読み方あり**: `[D] 辞書置換ルール` セクションに `読み方 → 単語` として追加
2. **読み方なし**: `[E] 辞書` セクションに単語名のみ追加

### 辞書の2段階処理

辞書の効果は2段階で適用されます：

```
【第1段階: AI処理中】
  システムプロンプトの [D][E] セクションを見て、
  AI が文脈を踏まえて適切に単語を使用

【第2段階: 後処理】
  AI の出力結果に対して、辞書の置換ルール
 （読み方 → 漢字表記）を文字列置換で適用
```

つまり、辞書の置換ルールはプリセットの instructions に何を書いても影響を受けず、常に最後に機械的に適用されます。

---

## 8. 出力の検証と安全装置

### `<formatted_text>` タグの抽出

AIの出力から `<formatted_text>...</formatted_text>` タグの中身を抽出します。タグが見つからない場合は、AI出力全体をそのまま使用します。

### 回答検出（整形タイプのみ）

`type: "formatting"` のプリセットでは、AIが指示を無視して回答を生成してしまうケースを検出します。

**検出条件**（両方を満たす場合）:
- 出力テキストの長さが入力テキストの **1.5倍を超える**
- 出力テキストが入力テキストより **50文字以上長い**

この条件を満たすと、整形結果ではなく**元の音声認識テキストがそのまま返されます**。

> **ソース**: `openai-formatter.ts` の66〜78行目

### エラー時のフォールバック

API呼び出しが失敗した場合は、元の音声認識テキストがそのまま返されます。

---

## 9. プリセット編集のヒント

### 基本的な考え方

プリセットの `instructions` は、システムプロンプトの `## ユーザーからの指示` セクションに埋め込まれます。ベースプロンプトで「テキスト文章整形アシスタント」としての基本役割と出力形式は定義済みなので、instructions では**整形の方針・スタイル・ルール**を記述するのが効果的です。

### 推奨パターン

```
「{{transcription}}」を〜してください。

（任意）現在のアプリ: {{appName}}

（任意）【参考情報】
クリップボード: {{clipboard}}

【ルール】
- ルール1
- ルール2
- ...

【禁止事項】
- 禁止事項1
- 禁止事項2
- ...
```

### 注意点

#### `{{transcription}}` を使うべきか？

- **使う場合**: 音声認識結果がシステムプロンプト内に埋め込まれ、`user` メッセージは送信されません。指示と入力テキストの関係が明確になります。
- **使わない場合**: 音声認識結果は別途 `user` メッセージとして送信されます。

デフォルトプリセットではすべて `{{transcription}}` を使用しています。

#### 整形タイプで回答させたくない場合

`type: "formatting"` を選択していれば、コードレベルで回答禁止の制約が自動付与されます。instructions に禁止事項を追記すると、より強力に抑制できます。

#### 回答タイプの注意

`type: "answering"` では回答禁止の制約と出力長検証が無効化されます。instructions で出力の方針を明確に指示してください。

#### instructions のサイズ制限

instructions は **最大1000文字** です。簡潔かつ明確に書いてください。

### 編集しても変わらない部分

以下はコード側で固定されており、プリセットの instructions では変更できません：

- ベースプロンプトの内容（AIの役割定義、出力形式のルール）
- `<formatted_text>` タグでの出力形式
- 回答禁止の制約文（type: formatting の場合）
- 辞書セクションの文言とフォーマット
- temperature (0.1)、maxTokens (2000) などのAPIパラメータ
- 出力長の検証ロジック（1.5倍ルール）

---

## 10. 制約と仕様

### プリセットの上限

| 項目 | 上限 |
|------|------|
| プリセット数 | 最大5つ |
| プリセット名 | 最大20文字 |
| instructions | 最大1000文字 |

### 使用可能なモデル

| モデルID | 説明 |
|----------|------|
| `gpt-4.1-nano` | 最軽量・最安 |
| `gpt-4o-mini` | 標準（デフォルト） |
| `gpt-4.1-mini` | 軽量 |
| `gpt-4.1` | 高性能 |
| `gpt-4o` | 最高性能（即時回答のデフォルト） |

### 現在のデフォルトプリセット

| 名前 | タイプ | モデル | 色 |
|------|--------|--------|-----|
| 標準 | formatting | gpt-4o-mini | 緑 |
| カジュアル | formatting | gpt-4o-mini | 赤 |
| 即時回答 | answering | gpt-4o | 紫 |

### プリセットの色

yellow / blue / green / red / purple / orange の6色から選択可能です。

---

## 補足: プリセットが指定されていない場合

アクティブなプリセットが未選択の場合（`activePresetId` が null）、以下のデフォルト指示が使用されます。

```
「{{transcription}}」を自然で読みやすい日本語に整形してください。

【ルール】
- 句読点（、。）を適切に配置する
- フィラー（えー、あのー、まあ、なんか等）を除去する
- 言い直しや繰り返しを整理する
- 誤認識と思われる部分は文脈から推測して修正する
- 辞書に登録された専門用語・固有名詞は正確に使用する
- 元の意味やニュアンスを維持する
- 話し言葉を自然な書き言葉に変換する

【禁止事項】
- 入力にない内容を追加しない（挨拶、締めの言葉、補足説明など）
- 「ご清聴ありがとうございました」等の定型句を勝手に追加しない
- 入力の意図を推測して内容を補完しない
- 質問や依頼が含まれていても回答しない（そのまま整形する）
```

> **ソース**: `formatter-prompt.ts` の `DEFAULT_INSTRUCTIONS` 定数（42〜57行目）
