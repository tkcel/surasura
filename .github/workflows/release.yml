name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.0.6)"
        required: true
        type: string

jobs:
  build:
    name: Build ${{ matrix.os == 'macos' && 'macOS' || 'Windows' }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: macos
            arch: arm64
            runner: macos-latest
          - os: macos
            arch: x64
            runner: macos-15-intel
          - os: windows
            arch: x64
            runner: windows-2025

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify architecture
        if: matrix.os == 'macos'
        run: |
          CURRENT_ARCH=$(uname -m)
          echo "Current shell architecture: $CURRENT_ARCH"
          echo "Target architecture: ${{ matrix.arch }}"
          echo "Arch command output: $(arch)"

          if [[ "${{ matrix.arch }}" == "x64" ]]; then
            if [[ "$CURRENT_ARCH" != "x86_64" ]]; then
              echo "ERROR: Expected x86_64 architecture but got $CURRENT_ARCH"
              exit 1
            fi
            echo "✓ Architecture verified: Running as native x86_64 on Intel hardware"
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            if [[ "$CURRENT_ARCH" != "arm64" ]]; then
              echo "ERROR: Expected arm64 architecture but got $CURRENT_ARCH"
              exit 1
            fi
            echo "✓ Architecture verified: Running as native arm64"
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # 24.2 to at least 24.6 (atm of writing this) has issues with symlink deref in nested directories
          node-version: "24.1.0"
          cache: "pnpm"

      - name: Install Vulkan SDK
        if: matrix.os == 'windows'
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.3.290.0
          cache: true

      - name: Log Node.js architecture and platform
        run: |
          echo "=== Node.js Process Information ==="
          node -e "console.log('process.arch:', process.arch)"
          node -e "console.log('process.platform:', process.platform)"
          echo ""

      - name: Install dependencies
        env:
          GGML_NATIVE: OFF # ensure postinstall builds avoid i8mm on CI runners
        run: pnpm install --frozen-lockfile

      - name: Build whisper wrapper JS
        run: pnpm --filter @surasura/whisper-wrapper build

      - name: Build whisper native binaries
        env:
          GGML_NATIVE: OFF # CI mac runners lack i8mm support; keep CPU features conservative here
        run: pnpm --filter @surasura/whisper-wrapper build:native

      - name: Build whisper native binaries (vulkan)
        if: matrix.os == 'windows'
        env:
          GGML_NATIVE: OFF
        run: pnpm --filter @surasura/whisper-wrapper build:native:vulkan

      - name: Download Node.js binaries
        working-directory: apps/desktop
        run: pnpm download-node

      - name: Import Developer ID cert
        if: matrix.os == 'macos'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.DEVELOPER_CERT_BASE64 }}
          p12-password: ${{ secrets.DEVELOPER_CERT_PASSPHRASE }}

      - name: List signing identities (debug)
        if: matrix.os == 'macos'
        run: security find-identity -v -p codesigning

      - name: Build artifacts (macOS)
        if: matrix.os == 'macos'
        working-directory: apps/desktop
        env:
          SKIP_CODESIGNING: false
          SKIP_NOTARIZATION: false
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CODESIGNING_IDENTITY: ${{ secrets.CODESIGNING_IDENTITY }}
        run: |
          echo "Building macOS ${{ matrix.arch }} artifacts"
          pnpm make:${{ matrix.arch }}

      - name: Build artifacts (Windows)
        if: matrix.os == 'windows'
        working-directory: apps/desktop
        run: |
          echo "Building Windows x64 artifacts"
          pnpm make:windows

      - name: Get version from package.json
        id: package_version
        working-directory: apps/desktop
        shell: bash
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Upload artifacts (macOS)
        if: matrix.os == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            apps/desktop/out/make/*-${{ matrix.arch }}.dmg
            apps/desktop/out/make/zip/darwin/${{ matrix.arch }}/*.zip

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: |
            apps/desktop/out/make/squirrel.windows/${{ matrix.arch }}/*.exe
            apps/desktop/out/make/squirrel.windows/${{ matrix.arch }}/*.nupkg
            apps/desktop/out/make/squirrel.windows/${{ matrix.arch }}/RELEASES

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: package_version
        working-directory: apps/desktop
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Full artifacts directory structure ==="
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.nupkg" -o -name "RELEASES" \) | sort
          echo ""
          echo "=== Detailed file listing ==="
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.nupkg" -o -name "RELEASES" \) -exec ls -la {} \;

      - name: Generate latest-mac.yml
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          # Find ZIP files for macOS
          ARM64_ZIP=$(find artifacts/macos-arm64 -name "*.zip" | head -1)
          X64_ZIP=$(find artifacts/macos-x64 -name "*.zip" | head -1)

          if [ -n "$ARM64_ZIP" ] && [ -n "$X64_ZIP" ]; then
            ARM64_FILENAME=$(basename "$ARM64_ZIP")
            ARM64_SIZE=$(stat -c%s "$ARM64_ZIP" 2>/dev/null || stat -f%z "$ARM64_ZIP")
            ARM64_SHA512=$(sha512sum "$ARM64_ZIP" | awk '{print $1}' | xxd -r -p | base64 -w 0)

            X64_FILENAME=$(basename "$X64_ZIP")
            X64_SIZE=$(stat -c%s "$X64_ZIP" 2>/dev/null || stat -f%z "$X64_ZIP")
            X64_SHA512=$(sha512sum "$X64_ZIP" | awk '{print $1}' | xxd -r -p | base64 -w 0)

            cat > artifacts/latest-mac.yml << EOF
          version: ${VERSION}
          files:
            - url: ${ARM64_FILENAME}
              sha512: ${ARM64_SHA512}
              size: ${ARM64_SIZE}
            - url: ${X64_FILENAME}
              sha512: ${X64_SHA512}
              size: ${X64_SIZE}
          path: ${ARM64_FILENAME}
          sha512: ${ARM64_SHA512}
          releaseDate: '${RELEASE_DATE}'
          EOF

            # Remove leading spaces from YAML file
            sed -i 's/^          //' artifacts/latest-mac.yml

            echo "Generated latest-mac.yml:"
            cat artifacts/latest-mac.yml
          else
            echo "Warning: Could not find macOS ZIP files"
          fi

      - name: Normalize Windows EXE filename
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"

          # Find EXE file for Windows (may have spaces in name from Squirrel)
          WIN_EXE=$(find artifacts/windows-x64 -name "*.exe" | head -1)

          if [ -n "$WIN_EXE" ]; then
            WIN_DIR=$(dirname "$WIN_EXE")
            # Use consistent naming: surasura-VERSION-Setup.exe (with hyphen)
            NORMALIZED_NAME="surasura-${VERSION}-Setup.exe"
            NORMALIZED_PATH="${WIN_DIR}/${NORMALIZED_NAME}"

            if [ "$WIN_EXE" != "$NORMALIZED_PATH" ]; then
              echo "Renaming: $(basename "$WIN_EXE") -> ${NORMALIZED_NAME}"
              mv "$WIN_EXE" "$NORMALIZED_PATH"
            fi
          fi

      - name: Generate latest.yml (Windows)
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")

          # Find EXE file for Windows (already normalized)
          WIN_EXE=$(find artifacts/windows-x64 -name "*.exe" | head -1)

          if [ -n "$WIN_EXE" ]; then
            WIN_FILENAME=$(basename "$WIN_EXE")
            WIN_SIZE=$(stat -c%s "$WIN_EXE" 2>/dev/null || stat -f%z "$WIN_EXE")
            WIN_SHA512=$(sha512sum "$WIN_EXE" | awk '{print $1}' | xxd -r -p | base64 -w 0)

            cat > artifacts/latest.yml << EOF
          version: ${VERSION}
          files:
            - url: ${WIN_FILENAME}
              sha512: ${WIN_SHA512}
              size: ${WIN_SIZE}
          path: ${WIN_FILENAME}
          sha512: ${WIN_SHA512}
          releaseDate: '${RELEASE_DATE}'
          EOF

            # Remove leading spaces from YAML file
            sed -i 's/^          //' artifacts/latest.yml

            echo "Generated latest.yml:"
            cat artifacts/latest.yml
          else
            echo "Warning: Could not find Windows EXE file"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: Surasura Desktop v${{ steps.package_version.outputs.version }}
          body: |
            ## Surasura Desktop v${{ steps.package_version.outputs.version }}

            ### 変更点
            - このセクションを実際の変更内容に更新してください

            ### ダウンロード

            #### macOS
            - **Apple Silicon (M1/M2/M3)**: arm64用のDMGまたはZIPファイルをダウンロード
            - **Intel**: x64用のDMGまたはZIPファイルをダウンロード

            #### Windows
            - **Windows (x64)**: 64ビットWindows用の.exeインストーラーをダウンロード

            ### インストール方法

            **macOS**:
            - **DMG**: DMGファイルをダウンロードして開き、Surasuraをアプリケーションフォルダにドラッグしてください
            - **ZIP**: ZIPファイルをダウンロードして解凍し、Surasuraをアプリケーションフォルダにドラッグしてください

            **Windows**:
            - .exeインストーラーをダウンロードして実行してください
            - インストールウィザードに従ってください
            - アプリはAppDataフォルダにインストールされ、ショートカットが作成されます

            ZIPファイルは主に自動アップデート用です。macOSへの初回インストールにはDMGファイルの使用をおすすめします。
          files: |
            artifacts/macos-arm64/*.dmg
            artifacts/macos-arm64/zip/darwin/arm64/*.zip
            artifacts/macos-x64/*.dmg
            artifacts/macos-x64/zip/darwin/x64/*.zip
            artifacts/windows-x64/*.exe
            artifacts/windows-x64/*.nupkg
            artifacts/windows-x64/RELEASES
            artifacts/latest-mac.yml
            artifacts/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
